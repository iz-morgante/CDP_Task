---
title: "CDP Technical Task - Junior Data Analyst"
author: "Isabella Morgante"
output:
  html_document: default
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::knit_hooks$set(inline = function(x) {
  x <- sprintf("%1.2f", x)
  paste(x, collapse = ", ")
})

setwd("~/Documents/CDP_Task/Code/") # set working directory

rm(list=ls(all=TRUE))
graphics.off()

# Packages
require(ggplot2)
require(dplyr)
require(rvest)

# Color blind palette for plots
cbp <- c("#000000", "#E69F00", "#56B4E9", "#009E73",
          "#D55E00", "#F0E442", "#0072B2", "#CC79A7", "#999999", "#C3D7A4")
```

This report documents the approach used to explore data relating to the electricity generation for the top 5 power generating countries over time by source. The code used to conduct final analyses is displayed below, all historic versions of the code can be found via this GitHub repository at <https://github.com/iz-morgante/CDP_Task>.

### Inspecting the Data 

The dataset was first inspected and assessed for quality and then each analysis question was addressed. 
To load the data, use the appropriate file path.

```{r}
cdp_data <- read.csv(file = "../Data/Electricity generation by source - top 5.csv", stringsAsFactors = TRUE)
```

Examine content and structure of the dataset.

```{r}
head(cdp_data) # View first few rows
str(cdp_data) # View data structure
```

The output shows that the data contains information about the electricity generation by source from 1990-2019. There are 6 *Country* categories representing the top 5 power generating countries and the global values. There are 10 types of electricity generation listed under the *Sources* column. The electricity generation units are consistent throughout, in GWh. 

The electricity generation data does contain missing values (NAs). This could be because data from a source was not reported or that a country did not generate electricity by a particular source for a given year. For this analysis, all rows containing missing electricity generation values were changed to zero.

```{r}
names(which(colSums(is.na(cdp_data))>0)) # List columns containing NAs

# Change column name to avoid dots and remove NAs
cdp_data <- rename(cdp_data, ElectricityGeneration_GWh = Electricity.Generation..GWh.) %>% replace(is.na(.), 0)
```

### Question 1: Total Electricity Generation
*Calculate the total electricity generation per year. How does this change overtime?*

To find the total electricity generated by each country per year, the amount of electricity generated by each source is summed for every year.

```{r, results='hide'}
total_electricity <- cdp_data  %>%
  group_by(Year, Country) %>%
  summarise(Total_ElectricityGeneration_GWh = sum(ElectricityGeneration_GWh))
```

The total electricity generation by each of the top 5 power generating countries over 30 years show some interesting tends (see figure below). Japan and the Russian Federation show little change in the total amount of electricity generated over time and the United States' generation appears to have plateaued since approximately 2006. Both India and China have shown increases in electricity generation in the past decade while the other countries' generation have stayed relatively consistent in the past 10 years.

From the figure, China has shown the most dramatic increase in their electricity generation, with the generation rate increasing. For this reason, I have selected China as my country of choice for further investigation. 

```{r, echo=FALSE, out.width = "75%"}
#Plots for countries
p_country_totals <- ggplot(filter(total_electricity, Country!='World'), aes(x = Year, y = Total_ElectricityGeneration_GWh, fill=Country)) + 
  geom_point(aes(color=Country, size=Country)) +
  geom_line(aes(color=Country, size=Country))+ 
  scale_size_manual(values=c(1.2, rep(0.5,4))) +
  theme_bw() + scale_color_manual(values = cbp) +
  scale_x_continuous(n.breaks = 10) +
  scale_y_continuous(n.breaks = 10) +
  ylab("Electricity Generation [GWh]") +
  ggtitle("Total Electricity Generation by Country")
  
p_country_totals
```

### Question 2: Fossil Fuel Generation
*What percentage of electricity is generated from fossil fuel sources per year?*

The total amount of electricity generated by fossil fuels was determined by summing the oil, coal and natural gas electricity generation for each country and year.  The total amount of electricity generation for each country and year was found by summing generation from all sources. The percentage of electricity generated by fossil fuels with respect to total electricity generation was then found by dividing by fossil fuel generation by total generation. The results are displayed in the figure below.

```{r, results='hide'}
FF_electricity <- filter(cdp_data, Source == "Coal"| Source =="Natural gas" | Source == "Oil") %>% # filter by fossil fuel
  group_by(Year, Country) %>% 
  summarise(FossilFuel_ElectricityGeneration_GWh = sum(ElectricityGeneration_GWh)) # sum generation values from all sources

FF_Total <- full_join(FF_electricity, total_electricity, by = c('Year', 'Country')) %>% # join total generation with fossil fuel generation
  mutate(
    Percent_FF = FossilFuel_ElectricityGeneration_GWh / Total_ElectricityGeneration_GWh * 100 # calculate percentage 
  )
```
```{r, echo=FALSE, out.width = "75%"}
p_FF_percent <- ggplot(filter(FF_Total, Country!='World'), aes(x = Year, y = Percent_FF, fill = Country)) + 
  geom_point(aes(color=Country, size=Country)) +
  geom_line(aes(color=Country, size=Country))+ 
  scale_size_manual(values=c(1.2, rep(0.5,4))) +
  theme_bw() + scale_color_manual(values = cbp) +
  scale_x_continuous(n.breaks = 10) +
  scale_y_continuous(n.breaks = 10, limits = c(50, 85)) + 
  ylab("Percentage") +
  ggtitle("Percentage of Electricity Generated by Fossil Fuels")

p_FF_percent
```

All the top five countries generate over 50% of their electricity using fossil fuels, with a general decline in fossil fuel usage since 2015. Patterns of usage over time differ between countries. China and the US show a similar trend, with fossil fuel usage peaking in the early 2000s followed by a consistent decline in usage until present day. Russia's usage has nearly always declined since 1990, whereas Japan has been increased fossil fuel usage until peaking in 2015, which was the highest recorded proportion of fossil fuel electricity generation in this dataset.

Focusing on China, its electricity generation by fossil fuels has been declining since 2000.  However, in comparison to the other countries, percentage still remains high. Looking at China's electricity generation by source (see below figure) reveal that its electricity is predominantly generated with coal, although the use of natural gas has been recently increasing.

```{r, echo=FALSE, out.width = "75%"}
p_sources <- ggplot(filter(cdp_data, Country == "China"), aes(x = Year, y = ElectricityGeneration_GWh, fill = Source)) + 
  geom_point(aes(color=Source)) +
  geom_line(aes(color=Source))+ 
  theme_bw() + 
  scale_color_manual(values = cbp)+
  scale_x_continuous(n.breaks = 10) +
  scale_y_continuous(n.breaks = 10, labels = scales::scientific) +
  ylab("Electricity Generation [GWh]") +
  ggtitle("China's Electricity Generation by Source") 
p_sources
```

### Question 3: Coal Generation
*For the most recent year, what percentage of world coal generation do the top five countries represent? How does this compare to natural gas?*

The most recent year recorded is 2019. Generation figures are provided for Japan, US, Russia and India in 2019, however, for the global values and China, the most recent generation figures are from 2018. 

```{r}
max(cdp_data$Year)
```

To extrapolate electricity generation by coal and gas for the World and China in 2019, mathematical models were fitted to the data and the best fitting model was used to predict values for 2019. Plots for electricity generation by coal and natural gas from China and the World were plotted and the shape of the graphs were used to select appropriate models for fitting.  

```{r, echo=FALSE, out.width = "75%"}
p <- ggplot(filter(cdp_data, Source == "Coal"| Source == "Natural gas", Country == "World" | Country == "China" ), aes(x = Year, y = ElectricityGeneration_GWh, fill = Source)) + 
  geom_point(aes(color=Country)) +
  geom_line(aes(color=Country, linetype = Source))+ 
  theme_bw() + scale_color_manual(values = c("#000000", "#56B4E9")) +
  scale_x_continuous(n.breaks = 10) +
  scale_y_continuous(n.breaks = 10) + 
  ylab("Electricity Generation GWh") +
  ggtitle("Electricity Generation by Coal or Gas") 
p
```

The plot shows a similar trend for each country and generation source, i.e. that electricity generation for the given sources is increasing at an increasing rate. Four mathematical models that reflect this trend were selected and fitted to the data: 2nd and 3rd order polynomials, an allometric curve and a Generalized Linear Model (GLM) with Gaussian distribution and a log link function. The best fitting model was that with the smallest Akaike information criterion (AIC). 

```{r, out.width="50%"}
cg_2019 <- filter(cdp_data, Source == "Coal" | Source=="Natural gas", Year == 2019) # Filter for only 2019 values

for (country in c("China", "World")){
  for (source in c("Coal", "Natural gas")){
    data2Fit <- filter(cdp_data, Source == source, Country == country)
   
    # Fit models
    QuadFit <- lm(ElectricityGeneration_GWh ~ poly(Year,2), data = data2Fit)
    CubFit <- lm(ElectricityGeneration_GWh ~ poly(Year,3), data = data2Fit)
    ExpFit <- lm(log(ElectricityGeneration_GWh) ~ log(Year), data = data2Fit)
    GLMFit <- glm(ElectricityGeneration_GWh ~ log(Year), data = data2Fit, family = gaussian(link = "log"))
    #NLS_Fit <- nlsLM(ElectricityGeneration_GWh ~ a * Year^b, data = data2Fit, start = list(a = exp(coef(ExpFit)[1]), b = coef(ExpFit)[2])) # Need better starting values
    
    # Plot the model fits
    plot(ElectricityGeneration_GWh ~ Year, data = data2Fit)
    curve(predict(QuadFit, newdata = data.frame(Year = x)), col = "black", add = TRUE)
    curve(predict(CubFit, newdata = data.frame(Year = x)), col = "orange", add = TRUE)
    curve(exp(predict(ExpFit, newdata = data.frame(Year = x))), col = "blue", add = TRUE)
    curve(predict(GLMFit, newdata = data.frame(Year = x), type = "response"), col = "red", add = TRUE)
    legend("topleft", legend = c("Quadratic", "Cubic", "Exponential", "Gauss GLM"),
           col = c("black", "orange", "blue", "red"),
           lty = c(1, 1, 1))
    title(main = paste(country, "-", source, sep=" "))
    
    # Find AIC for models and their predicted value for 2019
    AIC_values <- data.frame(Model  = c("QuadFit", "CubFit", "ExpFit", "GLMFit"), AIC = c(AIC(QuadFit), AIC(CubFit), AIC(ExpFit), AIC(GLMFit)), Prediction = c(as.numeric(predict(QuadFit, data.frame(Year = 2019))), as.numeric(predict(CubFit, data.frame(Year = 2019))), as.numeric(exp(predict(ExpFit, data.frame(Year = 2019)))), as.numeric(predict(GLMFit, data.frame(Year = 2019), type = "response")))) # Calculate AIC and predicted values for 2019
    
    # Select best fitting model by minimum AIC value 
    best_fit <- AIC_values[which.min(AIC_values$AIC), ] 

    # Add predicted value to 2019 data 
    cg_2019 <- cg_2019 %>% add_row(Year = 2019, Country = country, Units = "GWh", Source = source, ElectricityGeneration_GWh = best_fit$Prediction)
  }
}
```

Finally, to find the percentage of world coal generation the top five countries represent, the coal generation by each country was divided by the global generation for that year. The same method was used to find the values for natural gas. 
```{r}
coal_gas_percent_2019 <- full_join(filter(cg_2019, Country != "World"), filter(cg_2019, Country == "World"), by=c('Source', 'Year')) # Join world values as a column

coal_gas_percent_2019 <- rename(coal_gas_percent_2019, ElectricityGeneration_GWh_Country = ElectricityGeneration_GWh.x, ElectricityGeneration_GWh_World = ElectricityGeneration_GWh.y, Country = Country.x)

coal_gas_percent_2019 <- coal_gas_percent_2019 %>%  
  mutate(
    Percent_source = ElectricityGeneration_GWh_Country / ElectricityGeneration_GWh_World * 100 # calculate percentage 
  )
```

The percentage of global coal and gas electricity generation by the top five generating countries is displayed in the bar chart below. China generated more than 50% of global coal electricity in 2019, far more than any of the other top generating countries. Conversely, China's electricity that was generated by natural gas contributed to less than 5% of global generation.

```{r, echo=FALSE}
p_2019 <- ggplot(coal_gas_percent_2019, aes(x = Country, y = Percent_source, fill = Source)) + 
  geom_bar(position=position_dodge(), stat="identity") +
  theme_bw() + scale_fill_manual(values = c("#000000", "#56B4E9")) +
  scale_y_continuous(n.breaks = 10, limits = c(0, 60)) + 
  ylab("Percentage of World Generation") +
  ggtitle("Coal and Gas Electricity Generation in 2019") 
p_2019
```

Historically, it appears that the combined electricity generated from the top five countries by coal has an inverse relationship with generation by natural gas (see figure below). Before approximately 1992, a greater proportion of electricity was produced by natural gas, however, this has declined while coal production increased over time. 

```{r, results='hide'}
# Sum electricity generation by coal and gas for all countries
coal_gas_country <- filter(cdp_data, Source == "Coal" & Country != "World" | Source == "Natural gas" & Country != "World") %>%
  group_by(Year, Source) %>%
  summarise(ElectricityGeneration_GWh_TopFive = sum(ElectricityGeneration_GWh))

# Global coal and gas 
coal_gas_global <- filter(cdp_data, Source == "Coal" & Country == "World" | Source == "Natural gas" & Country == "World")
coal_gas_global <- select(coal_gas_global, -c(Country, Units))

# Divide country generation by global value to get proportion and join into single df
coal_gas <- full_join(coal_gas_country, coal_gas_global, by = c('Year','Source')) %>%
  group_by(Year, Source) %>%
  mutate(
    Percent = ElectricityGeneration_GWh_TopFive / ElectricityGeneration_GWh * 100
  )
coal_gas <- rename(coal_gas, ElectricityGeneration_GWh_Global = ElectricityGeneration_GWh)
```

```{r, echo=FALSE, out.width = "75%"}
# Plot changes until 2015
coal_gas_2015 <- filter(coal_gas, Year < 2018)
p_coal_gas_changes_2015 <- ggplot(coal_gas_2015, aes(x = Year, y = Percent, fill = Source)) + 
  geom_point(aes(color=Source)) +
  geom_line(aes(color=Source))+ 
  theme_bw() + scale_color_grey()+
  scale_x_continuous(n.breaks = 10) +
  scale_y_continuous(n.breaks = 10) +
  ylab("Percentage") + 
  ggtitle("Combined percentage of gobal coal or gas electricity generation \n by the combined top five countries")

p_coal_gas_changes_2015
```

### Question 4: Total GHG Lifecycle Emissions
*Using data from the previous exercise with the table you have just extracted, calculate the total GHG lifecycle emissions per year for a country of your choice using the provided equation.*

The ‘Lifecycle greenhouse gas emissions by electricity source’ table was extracted from <https://en.wikipedia.org/wiki/Emission_intensity> using `rvest` package and the appropriate XPath was found by inspecting the source code of the Wikipedia webpage.
```{r}
url <- "https://en.wikipedia.org/wiki/Emission_intensity"
table_XPath <- '//*[@id="mw-content-text"]/div[1]/table[1]'

lifecycle_GHG_emissions <- url %>%
  read_html() %>%
  html_nodes(xpath=table_XPath) %>%
  html_table()
lifecycle_GHG_emissions <-lifecycle_GHG_emissions[[1]]
glimpse(lifecycle_GHG_emissions)
```

The table contains information about lifecycle greenhouse gas emissions by electricity source. The column names of the lifecycle data were matched to the data provided by CDP and the names of the generation sources were compared between datasets to check for consistency.

```{r}
lifecycle_GHG_emissions <- rename(lifecycle_GHG_emissions, Source = Technology, GHG_EF = `50th percentile  (g CO2-eq/kWhe)`) # Rename columns to match CDP data

# Check differences between Sorce values 
setdiff(lifecycle_GHG_emissions$Source, cdp_data$Source)
```

To calculate the total GHG lifecycle emissions per year, the lifecycle emissions data and the CDP electricity data were merged by electricity source.  CDP electricity generation was converted from GWh to kWh and the emissions were calculated using:

$$
 Lifecycle\_GHG\_Emissions (gCO_2eq) = Electricity\_Generation (kWh) * Lifecycle\_GHG\_EF (gCO_2eq/kWh)
$$

```{r, results='hide'}
## Add GHG values to cdp data to find emissions
emissions <- full_join(cdp_data, lifecycle_GHG_emissions, by = c('Source')) %>% na.omit() %>% # NAs will be additional sources that were included in the wiki data that didn't match CDP data
  mutate(
    ElectricityGeneration_kWh = ElectricityGeneration_GWh * 1e6, #Convert from GWh to kWh
    GHG_Emissions = ElectricityGeneration_kWh * GHG_EF # Calculate emissions
  )
        
total_emissions <- emissions %>%
  group_by(Year, Country) %>%
  summarise(Total_GHG_Emissions = sum(GHG_Emissions))
```

There is a marked difference between the GHG electricity generation emissions from China in comparison to the other countries, as can be seen from the above figure. China's GHG emissions are over double that of any other country in 2018, and their GHG emissions have been increasing at an increasing rate since 1990. The USA's GHG emissions have been declining and Japan and Russia's emissions have not shown great change over time. 

```{r, echo=FALSE, out.width = "75%"}
p_GHG_emissions <- ggplot(filter(total_emissions, Country != "World"), aes(x = Year, y = Total_GHG_Emissions, fill = Country)) + 
  geom_point(aes(color=Country, size=Country)) +
  geom_line(aes(color=Country, size=Country))+
  scale_size_manual(values=c(1.2, rep(0.5,4))) +
  theme_bw() + scale_color_manual(values = cbp) +
  scale_x_continuous(n.breaks = 10) +
  scale_y_continuous(n.breaks = 10) +
  theme_bw() +
  ylab(bquote('GHG Emissions (g'~CO[2]~'eq)')) +
  ggtitle("GHG Emissions by Country")

p_GHG_emissions
```