---
title: "CDP Technical Task - Junior Data Analyst"
author: "Isabella Morgante"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/Documents/CDP_Task/Code/") # set working directory

rm(list=ls(all=TRUE))
graphics.off()

# Packages
require(ggplot2)
require(dplyr)
require(rvest)
require(gridExtra)
```

This report documents the approach used to explore data relating to the electricity generation for the top 5 power generating countries by source and over time. The code used to conduct final analyses is displayed below, all historic versions of the code can be found via this projects repository at <https://github.com/iz-morgante/CDP_Task>.

### Inspecting the Data 

The dataset was first inspected and assessed for quality and then each analysis question was addressed. 
To load the data, use the appropriate file path.

```{r}
cdp_data <- read.csv(file = "../Data/Electricity generation by source - top 5.csv", stringsAsFactors = TRUE)
```
Examine content and structure of the dataset.
```{r}
head(cdp_data) # View first few rows
str(cdp_data) # View data structure
```
The output shows that the data contains information about the electricity generation by generation source from 1990-2019. There are 6 *Country* categories representing the top 5 power generating countries as well as global values. There are 10 types of electricity generation listed under the *Sources* column. The electricity generation units are consistent throughout, GWh, as shown bythe *Units* column having only one factor, GWh. 

The electricity generation data does contain missing values (NAs). For this exercise, it has been assumed that missing generation values are due to a country not generating electricity by a particular source for that year. Following this assumption, all rows containing missing electricity generation data have been changed to zero for all analyses.

```{r}
names(which(colSums(is.na(cdp_data))>0)) # List columns containing NAs

# Change column name to avoid dots and remove NAs
cdp_data <- rename(cdp_data, ElectricityGeneration_GWh = Electricity.Generation..GWh.) %>% replace(is.na(.), 0)
```

### Question 1: Total Electricity Generation

*Calculate the total electricity generation per year. How does this change overtime?*

To find the total electricity generated by each country per year, the amount of electricity generation from each source is summed for every year.

```{r}
total_electricity <- cdp_data  %>%
  group_by(Year, Country) %>%
  summarise(Total_ElectricityGeneration_GWh = sum(ElectricityGeneration_GWh))
```

The total electricity generation by top 5 power generating countries over 30 years show some interesting tends (see figure below). Japan and the Russian Federation show little change in the total amount of electricity generation over time and the United States' generation appears to have plateaued since 2005. Both India and China have seen an increase in electricity generation.

From the figure, China has shown the most dramatic increase in their electricity generation, with the generation rate increasing. For this reason, I have selected China as my country of choice for further investigation. 

**DO FURTHER ANALYSIS HERE -- % change since 1990? see what type of growth?  HOW DOES THIS CHANGE OVER TIME**

```{r, echo=FALSE}
#Plots for countries
p_country_totals <- ggplot(filter(total_electricity, Country!='World'), aes(x = Year, y = Total_ElectricityGeneration_GWh, fill = Country)) + 
  geom_point(aes(color=Country)) +
  geom_line(aes(color=Country))+ 
  theme_bw() + 
  ylab("Electricity Generation [GWh]") +
  ggtitle("Total Electricity Generation by Country")
  
p_country_totals
```

### Question 2: Fossil Fuel Generation
*What percentage of electricity is generated from fossil fuel sources per year?*

The amount of electricity that is generated by fossil fuels was determined by summing the electricity generated by oil, coal and natural gas for each year. Then the total amount of electricity generation per year for each country was added to the fossil fuel generation dataset. Finally, the percentage of electricity generated by fossil fuels with respect to total electricity generation was found by dividing by fossil fuel generation by total generation. The results may be seen in the figure below.

```{r}
FF_electricity <- filter(cdp_data, Source == "Coal"| Source =="Natural gas" | Source == "Oil") %>% # filter by fossil fuel
  group_by(Year, Country) %>% 
  summarise(FossilFuel_ElectricityGeneration_GWh = sum(ElectricityGeneration_GWh)) # sum generation values from all sources

FF_Total <- full_join(FF_electricity, total_electricity, by = c('Year', 'Country')) %>% # join total generation with fossil fuel generation
  mutate(
    Percent_FF = FossilFuel_ElectricityGeneration_GWh / Total_ElectricityGeneration_GWh * 100 # calculate percentage 
  )
```
```{r, echo=FALSE}
p_FF_percent <- ggplot(filter(FF_Total, Country!='World'), aes(x = Year, y = Percent_FF, fill = Country)) + 
  geom_point(aes(color=Country)) +
  geom_line(aes(color=Country))+ 
  theme_bw() +
  ylab("Percentage") +
  ggtitle("Percentage of Electricity Generated by Fossil Fuels")

p_FF_percent
```

All the countries generate over 50% of their electricity using fossil fuels, with a general decline in their use since 2015. Patterns of fossil fuel usage over time differ between countries. China and the US show a similar trend, with fossil fuel usage peaking in the early 2000s with a consistent decline in usage until present day. Russia's usage has nearly always been declining since 1990, whereas Japan has been increasing usage until peaking in 2015 with the highest recorded proportion of fossil fuel electricity.

Focusing on China, its electricity generation by fossil fuels has been declining since 2000.  However, in comparison to the other countries, its generation of electricity by fossil fuel remains high. A deeper look at China's electricity generation by source (see below figure) reveal that its electricity is predominantly generated with coal, although the use of natural gas appears to be growing.

```{r, echo=FALSE, out.width = "50%"}
p_FF_china <- ggplot(filter(FF_Total, Country=='China'), aes(x = Year, y = Percent_FF)) + 
  geom_point() +
  geom_line()+ 
  theme_bw() +
  ylab("Percentage") +
  ggtitle("Percentage of Electricity Generated by Fossil Fuels in China")
p_FF_china
```
```{r, echo=FALSE, out.width = "47%"}
p_sources <- ggplot(filter(cdp_data, Country == "China"), aes(x = Year, y = ElectricityGeneration_GWh, fill = Source)) + 
  geom_point(aes(color=Source)) +
  geom_line(aes(color=Source))+ 
  theme_bw() +
  ylab("Electricity Generation [GWh]") +
   ggtitle("China's Electricity Generation by Source") + 
  theme(legend.position="bottom")
p_sources
```

### Question 3: Coal Generation
*For the most recent year, what percentage of world coal generation do the top five countries represent? How does this compare to natural gas?*

The most recent year recorded in the data is 2019. Generation figures are given for Japan, US, Russia and India in 2019, however, for the global values and China the most recent generation figures are from 2018. The generation values in 2019 for China and the World were predicted by linear extrapolation, using generation data from 2015 and 2018 as sample points.

```{r}
coal_gas_2019 <- filter(cdp_data, Source == "Coal" | Source=="Natural gas", Year == 2019)
coal_gas_extrap <- filter(cdp_data, Source == "Coal" | Source=="Natural gas", Country == "World" | Country == "China", Year > 2014)

for (country in unique(coal_gas_extrap$Country)){
  for (source in unique(coal_gas_extrap$Source)){
    d <- filter(coal_gas_extrap, Source == source, Country == country)
    model <- lm(ElectricityGeneration_GWh ~ Year, data = d)
    elec_gen_19 <- as.numeric(predict(model, data.frame(Year = 2019)))
 
    coal_gas_2019 <- coal_gas_2019 %>% add_row(Year = 2019, Country = country, Units = "GWh", Source = source, ElectricityGeneration_GWh = elec_gen_19)
  }
}

coal_gas_sums_2019 <- filter(coal_gas_2019, Country != "World") %>%
  group_by(Year, Source) %>%
  summarise(ElectricityGeneration_GWh = sum(ElectricityGeneration_GWh)) 
  
percent_coal_2019 <- filter(coal_gas_sums_2019, Source == "Coal") %>% pull(ElectricityGeneration_GWh) / filter(coal_gas_2019, Source == "Coal", Country == "World") %>% pull(ElectricityGeneration_GWh)

percent_gas_2019 <- filter(coal_gas_sums_2019, Source == "Natural gas") %>% pull(ElectricityGeneration_GWh) / filter(coal_gas_2019, Source == "Natural gas", Country == "World") %>% pull(ElectricityGeneration_GWh)
```

In 2019, the percentage of world coal electricity generation the top five countries represent was `r percent_coal_2019`. In comparison, the percentage gas electricity generation was much lower at `r percent_gas_2019`.

Historically show how natural gas and coal have changed over time (crossover in approx. 1992) and give additional plot.  

```{r}
# Sum electricity generation by coal and gas for all countries
coal_gas_country <- filter(cdp_data, Source == "Coal" & Country != "World" | Source == "Natural gas" & Country != "World") %>%
  group_by(Year, Source) %>%
  summarise(ElectricityGeneration_GWh_TopFive = sum(ElectricityGeneration_GWh))

# Global coal and gas 
coal_gas_global <- filter(cdp_data, Source == "Coal" & Country == "World" | Source == "Natural gas" & Country == "World")
coal_gas_global <- select(coal_gas_global, -c(Country, Units))

# Divide country generation by global value to get proportion and join into single df
coal_gas <- full_join(coal_gas_country, coal_gas_global, by = c('Year','Source')) %>%
  group_by(Year, Source) %>%
  mutate(
    Percent = ElectricityGeneration_GWh_TopFive / ElectricityGeneration_GWh
  )
coal_gas <- rename(coal_gas, ElectricityGeneration_GWh_Global = ElectricityGeneration_GWh)
```


```{r, echo=FALSE}
# Plot changes until 2015
coal_gas_2015 <- filter(coal_gas, Year < 2018)
p_coal_gas_changes_2015 <- ggplot(coal_gas_2015, aes(x = Year, y = Percent, fill = Source)) + 
  geom_point(aes(color=Source)) +
  geom_line(aes(color=Source))+ 
  theme_bw() +
  ylab("Electricity Generation [GWh]") 

p_coal_gas_changes_2015
```

### Question 4: Total GHG Lifecycle Emissions
*Using data from the previous exercise with the table you have just extracted, calculate the total GHG lifecycle emissions per year for a country of your choice using the provided equation.*

The ‘Lifecycle greenhouse gas emissions by electricity source’ table was extracted from <https://en.wikipedia.org/wiki/Emission_intensity> using `rvest` package and the appropriate XPath was found by inspecting the source code of the Wikipedia webpage.
```{r}
url <- "https://en.wikipedia.org/wiki/Emission_intensity"
table_XPath <- '//*[@id="mw-content-text"]/div[1]/table[1]'

lifecycle_GHG_emissions <- url %>%
  read_html() %>%
  html_nodes(xpath=table_XPath) %>%
  html_table()
lifecycle_GHG_emissions <-lifecycle_GHG_emissions[[1]]
glimpse(lifecycle_GHG_emissions)
```

The table contains information about lifecycle greenhouse gas emissions by electricity source. The column names of the lifecycle data were matched to the data provided by CDP and the names of the generation sources were compared between datasets to check for consistency.

```{r}
lifecycle_GHG_emissions <- rename(lifecycle_GHG_emissions, Source = Technology, GHG_EF = `50th percentile  (g CO2-eq/kWhe)`) # Rename columns to match CDP data

# Check differences between Sorce values 
setdiff(lifecycle_GHG_emissions$Source, cdp_data$Source)
```

To calculate the total GHG lifecycle emissions per year, the lifecycle emissions data and the CDP electricity data were merged by electricity source.  CDP electricity generation was converted from GWh to kWh and the emissions were calculated using:

$$
 Lifecycle\_GHG\_Emissions (gCO_2eq) = Electricity\_Generation (kWh) * Lifecycle\_GHG\_EF (gCO_2eq/kWh)
$$

```{r}
## Add GHG values to cdp data to find emissions
emissions <- full_join(cdp_data, lifecycle_GHG_emissions, by = c('Source')) %>% na.omit() %>% # NAs will be additional sources that were included in the wiki data that didn't match CDP data
  mutate(
    ElectricityGeneration_kWh = ElectricityGeneration_GWh * 1e6, #Convert from GWh to kWh
    GHG_Emissions = ElectricityGeneration_kWh * GHG_EF # Calculate emissions
  )
        
total_emissions <- emissions %>%
  group_by(Year, Country) %>%
  summarise(Total_GHG_Emissions = sum(GHG_Emissions))
```

```{r, echo=FALSE}
p_GHG_emissions <- ggplot(filter(total_emissions, Country != "World"), aes(x = Year, y = Total_GHG_Emissions, fill = Country)) + 
  geom_point(aes(color=Country)) +
  geom_line(aes(color=Country))+ 
  theme_bw() +
  ylab("GHG Emissions (gCO_2eq)") +
  ggtitle("GHG Emissions by Country")

p_GHG_emissions
```

There is a marked difference between the GHG electricity generation emissions from China in comparison to the other countries, as can be seen from the above figure. China's GHG emissions are over double that of any other country in 2018, and their GHG emissions have been increasing at an increasing rate since 1990. The USA's GHG emissions have been slowly declining and Japan and Russia's emissions have not shown great change over time. 