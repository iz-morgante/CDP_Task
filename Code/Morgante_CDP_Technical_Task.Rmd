---
title: "CDP Technical Task - Junior Data Analyst"
author: "Isabella Morgante"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/Documents/CDP_Task/Code/") # set working directory
rm(list=ls(all=TRUE))
graphics.off()
require(ggplot2)
require(dplyr)
```

This report documents the approach used to explore the electricity generation by source for the top 5 power generating countries over time. 
The dataset was first inspected and assessed for quality and then each analysis question was addressed. 

### Inspecting the Data 

Load the data using the appropriate file path.

```{r}
cdp_data <- read.csv(file = "../Data/Electricity generation by source - top 5.csv", stringsAsFactors = TRUE)
```
Examine content and structure of the dataset.
```{r}
head(cdp_data) # View first few rows
str(cdp_data) # View data structure
```
The output shows the data contains information about the electricity generation by source and country from 1990-2019. There are 6 *Country* categories representing the top 5 power generating countries and global values. There are 10 types of electricity generation listed under the *Sources* column. The electricity generation units are consistent throughout the data as the *Units* column has only one factor, GWh. 

The electricity generation data contains missing values (NAs). For the purpose of this exercise, the assumption has been made that the  missing values are due to a country not generating electricity by a particular source for that year. Following this assumption, all rows containing missing electricity generation data have been omitted from analysis.

```{r}
names(which(colSums(is.na(cdp_data))>0)) # List columns containing NAs
head(cdp_data[rowSums(is.na(cdp_data)) > 0, ]) # List first rows that contain NAs

# Change column name to avoid dots and remove NAs
cdp_data <- rename(cdp_data, ElectricityGeneration_GWh = Electricity.Generation..GWh.) %>% na.omit()
###### FIND WAY TO REPESENT THIS AS GRAPH NOT JUST AS A TABLE.  REPORT NUMBER OF NA rows
```

### Question 1: Total Electricity Generation

*Calculate the total electricity generation per year. How does this change overtime?*

To find the total electricity generated by each country per year, the amount of generation from each source is summed.

```{r}
total_electricity <- cdp_data  %>%
  group_by(Year, Country) %>%
  summarise(Total_ElectricityGeneration_GWh = sum(ElectricityGeneration_GWh))
```
The total electricity generation by top 5 power generating countries over 30 years show some interesting tends (see below figures). Japan and the Russian Federation show little change in the total amount of electricity generation and the United States' electricity generation appears to have plateaued since 2005. Both India and China have seen an increase in electricity generation.

From the figure, China showed the most dramatic change in their electricity generation, with an increasing rate of generation. I have selected China as my country of choice for further investigation.

**DO FURTHER ANALYSIS HERE -- % change since 1990? see what type of growth?  HOW DOES THIS CHANGE OVER TIME**

```{r, echo=FALSE}
#Plots for countries
p_country_totals <- ggplot(filter(total_electricity, Country!='World'), aes(x = Year, y = Total_ElectricityGeneration_GWh, fill = Country)) + 
  geom_point(aes(color=Country)) +
  geom_line(aes(color=Country))+ 
  theme_bw() + 
  #theme(legend.position="bottom") +
  ylab("Total Electricity Generation [GWh]") 
  
p_country_totals
```

### Question 2: Fossil Fuel Generation
*What percentage of electricity is generated from fossil fuel sources per year?*

First the original data is subset by the country of interest (in this analysis China has been selected).
```{r}
# Choose country to explore
country <- "China"
country_data <- filter(cdp_data, Country == country)
```


The amount of electricity generation by different sources in China over time can be seen in the figure below. The majority of electricity is generated by coal in China followed by natural gas, the other sources of electricity represent a small proportion of overall generation.

```{r, echo=FALSE}
p_sources <- ggplot(country_data, aes(x = Year, y = ElectricityGeneration_GWh, fill = Source)) + 
  geom_point(aes(color=Source)) +
  geom_line(aes(color=Source))+ 
  theme_bw() +
  ylab("Electricity Generation [GWh]") 

p_sources
```

To explore how the amount of electricity generated by fossil fuels have changed over time, a the proportion of electricity generated by fossil fuels (oil, coal and natural gas) with respect to total electricity generation is found.

First the combined amount of electricity generated by fossil fuels per year is found. 

```{r}
FF_electricity <- filter(cdp_data, Source == "Coal"| Source =="Natural gas" | Source == "Oil") %>% # filter by fossil fuel
  group_by(Year, Country) %>% 
  summarise(FossilFuel_ElectricityGeneration_GWh = sum(ElectricityGeneration_GWh)) # sum generation values from all sources

FF_Total <- full_join(FF_electricity, total_electricity, by = c('Year', 'Country')) %>% # join total generation with fossil fuel generation
  mutate(
    Percent_FF = FossilFuel_ElectricityGeneration_GWh / Total_ElectricityGeneration_GWh # calculate percentage 
  )
```

Then the amount of fossil fuel electricity generation is found as a percentage of total generation and is recorded in a new dataframe.

The percentage of electricity generated by fossil fuels in China can be seen in the figure below.  From about 2000, the proportion of China's electricity that is generated by fossil fuels has been steadily declining.  However, despite these reductions, China is still producing the majority of its electricity by fossil fuels.

```{r, echo=FALSE}
p_FF_percent <- ggplot(FF_Total, aes(x = Year, y = Percent_FF, fill = Country)) + 
  geom_point(aes(color=Country)) +
  geom_line(aes(color=Country))+ 
  theme_bw() +
  ylab("Percentage electricity generated by fossil fuels") 

p_FF_percent
```

### Question 3: Coal Generation
*For the most recent year, what percentage of world coal generation do the top five countries represent? How does this compare to natural gas?*

The total electricity generation by coal and gas for the top five countries was found by summing their values for each year. To calculate the proportion the top five countries represent relative to global generation figures, the total electricity generation by the top five countries was divided by the total generation by the World for a given year. 

```{r}
# Sum electricity generation by coal and gas for all countries
coal_gas_country <- filter(cdp_data, Source == "Coal" & Country != "World" | Source == "Natural gas" & Country != "World") %>%
  group_by(Year, Source) %>%
  summarise(ElectricityGeneration_GWh_TopFive = sum(ElectricityGeneration_GWh))

# Global coal and gas 
coal_gas_global <- filter(cdp_data, Source == "Coal" & Country == "World" | Source == "Natural gas" & Country == "World")
coal_gas_global <- select(coal_gas_global, -c(Country, Units))

# Divide country generation by gloabl value to get proportion and join into single df
coal_gas <- full_join(coal_gas_country, coal_gas_global, by = c('Year','Source')) %>%
  group_by(Year, Source) %>%
  mutate(
    Percent = ElectricityGeneration_GWh_TopFive / ElectricityGeneration_GWh
  )
rename(coal_gas, ElectricityGeneration_GWh_Global = ElectricityGeneration_GWh)

glimpse(coal_gas)
names(which(colSums(is.na(coal_gas))>0))
```

This proportion calculation works well for the years 1990-2015, as there is electricity data for all countries and the global total for each year. However, for 2018/2019 there is an issue because global electricity generation figures are quoted for 2018, but all countries (aside from China) report their generation figures in 2019. Hence, some NA values appear in the Percent and global electricity generation columns for 2019.  

This year mismatch must be treated with care. Interpolate to find 2018 values for the four countries recored in 2019. 


```{r, echo=FALSE}
# Plot changes until 2015
coal_gas_2015 <- filter(coal_gas, Year < 2018)
p_coal_gas_changes_2015 <- ggplot(coal_gas_2015, aes(x = Year, y = Percent, fill = Source)) + 
  geom_point(aes(color=Source)) +
  geom_line(aes(color=Source))+ 
  theme_bw() +
  ylab("Electricity Generation [GWh]") 

p_coal_gas_changes_2015
```




### Question 4: Total GHG Lifecycle Emissions
*Using data from the previous exercise with the table you have just extracted, calculate the total GHG lifecycle emissions per year for a country of your choice using the provided equation.*

The ‘Lifecycle greenhouse gas emissions by electricity source’ table was extracted from <https://en.wikipedia.org/wiki/Emission_intensity> using `rvest` package and the appropriate XPath was found by inspecting the source code of the Wikipedia webpage.

```{r}
require(rvest)

url <- "https://en.wikipedia.org/wiki/Emission_intensity"
table_XPath <- '//*[@id="mw-content-text"]/div[1]/table[1]'

lifecycle_GHG_emissions <- url %>%
  read_html() %>%
  html_nodes(xpath=table_XPath) %>%
  html_table()
lifecycle_GHG_emissions <-lifecycle_GHG_emissions[[1]]
lifecycle_GHG_emissions <- rename(lifecycle_GHG_emissions, Source = Technology, GHG_EF = `50th percentile  (g CO2-eq/kWhe)`) # Rename columns to match CDP data
```


```{r}
## View lifecycle GHG data
head(lifecycle_GHG_emissions)
str(lifecycle_GHG_emissions)

## Add GHG values to cdp data to find emissions
emissions <- full_join(cdp_data, lifecycle_GHG_emissions, by = c('Source')) %>% na.omit() %>% # Nas will be produced from countries not generating electricity by a certain source one year and any additional Sources that were included in the wiki data (i.e. didn't match).
  mutate(
    ElectricityGeneration_kWh = ElectricityGeneration_GWh * 1e6, #Convert from GWh to kWh
    GHG_Emissions = ElectricityGeneration_kWh * GHG_EF # Calculate emissions
  )
        
  
total_emissions <- emissions %>%
  group_by(Year, Country) %>%
  summarise(Total_GHG_Emissions = sum(GHG_Emissions))
```

```{r, echo=FALSE}
p_GHG_emissions <- ggplot(filter(total_emissions, Country != "World"), aes(x = Year, y = Total_GHG_Emissions, fill = Country)) + 
  geom_point(aes(color=Country)) +
  geom_line(aes(color=Country))+ 
  theme_bw() +
  ylab("GHG Emissions") 

p_GHG_emissions
```
